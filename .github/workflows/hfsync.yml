name: Sync to Hugging Face Hub (git-xet, single-step)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sync-to-hf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Build cleaned repo, install git-xet, commit & push (single step)
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USER: will-s-hart
          HF_REPO: spaces/will-s-hart/wcmbot
          GIT_COMMIT_NAME: "github-actions[bot]"
          GIT_COMMIT_EMAIL: "github-actions[bot]@users.noreply.github.com"
        run: |
          set -euo pipefail
          # --- prepare clean working copy ---
          CLEAN_DIR=$(mktemp -d)
          echo "Preparing clean copy at $CLEAN_DIR"
          rsync -a --delete --exclude='.git' ./ "$CLEAN_DIR/"

          cd "$CLEAN_DIR"

          # initialize fresh git repo and branch
          git init
          git checkout -b main

          # set local commit identity (ensures commits succeed)
          git config user.name "${GIT_COMMIT_NAME}"
          git config user.email "${GIT_COMMIT_EMAIL}"

          # --- install prerequisites (git-lfs) ---
          sudo apt-get update
          sudo apt-get install -y git-lfs
          git lfs install --skip-repo

          # --- install git-xet (official install script) ---
          # this will place git-xet into /usr/local/bin or ~/.local/bin
          curl -sSf https://raw.githubusercontent.com/huggingface/xet-core/refs/heads/main/git_xet/install.sh | sh

          # ensure git-xet is on PATH
          export PATH="$HOME/.local/bin:/usr/local/bin:$PATH"
          if ! command -v git-xet > /dev/null 2>&1; then
            echo "git-xet not found on PATH; listing ~/.local/bin and /usr/local/bin for debugging:"
            ls -la ~/.local/bin || true
            ls -la /usr/local/bin || true
            exit 1
          fi

          # register xet as transfer agent for this fresh repo
          git xet install

          # --- configure xet tracking for your binary paths ---
          # track entire media directory; change to specific files if you prefer
          git xet track "media/**"
          echo "---- .gitattributes ----"
          cat .gitattributes || true
          echo "------------------------"

          # --- commit changes if any ---
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit (clean copy identical). Exiting."
            exit 0
          fi
          git commit -m "Sync to HF Space (xet-tracked binaries)"

          # --- push to Hugging Face Space using token secret ---
          # push via HTTPS with token embedded (masked in logs)
          HF_REMOTE_URL="https://${HF_USER}:${HF_TOKEN}@huggingface.co/${HF_REPO}.git"
          git remote add hf "${HF_REMOTE_URL}"

          # Force push branch
          echo "Pushing cleaned repo to Hugging Face Space..."
          git push --force hf main

          echo "Done."
