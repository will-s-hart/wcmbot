name: Sync to Hugging Face Hub (git-xet, single-step)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  sync-to-hf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Build cleaned repo, pin version, install git-xet, commit & push
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USER: will-s-hart
          HF_REPO: spaces/will-s-hart/wcmbot
          GIT_COMMIT_NAME: "github-actions[bot]"
          GIT_COMMIT_EMAIL: "github-actions[bot]@users.noreply.github.com"
        run: |
          set -euo pipefail

          # Resolve version directly from package (versioneer-backed)
          VERSION=$(python -c "import wcmbot; print(wcmbot.__version__)")
          echo "Resolved version: $VERSION"

          # Prepare clean working copy
          CLEAN_DIR=$(mktemp -d)
          rsync -a --delete --exclude='.git' ./ "$CLEAN_DIR/"
          cd "$CLEAN_DIR"

          # Init fresh repo
          git init
          git checkout -b main
          git config user.name "${GIT_COMMIT_NAME}"
          git config user.email "${GIT_COMMIT_EMAIL}"

          # Overwrite versioneer file with pinned version
          printf '%s\n' \
            '# Auto-generated during HF sync' \
            'def get_versions():' \
            "    return {'version': \"${VERSION}\"}" \
            '' \
            "__version__ = get_versions()['version']" \
            > wcmbot/_version.py

          # Install git-lfs
          sudo apt-get update -qq
          sudo apt-get install -y git-lfs
          git lfs install --skip-repo

          # Install git-xet
          curl -sSf https://raw.githubusercontent.com/huggingface/xet-core/refs/heads/main/git_xet/install.sh | sh
          export PATH="$HOME/.local/bin:/usr/local/bin:$PATH"
          git xet install

          # Track media files with xet
          git xet track "media/**"

          # Commit and push
          git add -A
          git commit -m "Sync to HF Space (pinned version ${VERSION})"

          git remote add hf "https://${HF_USER}:${HF_TOKEN}@huggingface.co/${HF_REPO}.git"
          git push --force hf main
